# 零、知识点：

1. ECC：Error Checking and Correction
   1. 保护SRAM，可以对1位错误纠正，2位错误上报系统；
   2. 蜂鸟中对ITCM、DTCM中SRAM进行保护；

## 1、ram

### 1. sirv_sim_ram：仿真SRAM，将x不定态->0

+ 参数：
  + FORCE_X2ZERO：有效->输出不定态变为0；
  + DP：
  + DW：din width；
  + AW：addr width；
  + MW：mask width；
+ 信号接口：
  + wem：wirte enable mask，默认4bits对应写入数据4byte，写入掩码每一位对应；
  + cs：有效才可以进行读写；
  + we：write enable；有效->write，无效->read；

### 2. sirv_gnrl_ram：ram顶层

+ BUG：sd、ds、ls，无用信号；
+ sirv_gnrl_dfflr：通过always块编写寄存器逻辑；
+ <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230316202313497.png" alt="image-20230316202313497" style="zoom:80%;" />
+ sirv_gnrl_icb_n2w：位宽转换模块 将lsu32位换为64位；
+ sirv_gnrl_icb_arbt：ICB总线仲裁模块；
+ sirv_gnrl_fifo：通过配置DP大小，从而得到不同深度的fifo；
  + 0->单口ram；
  + 1：ready信号与下一级ready信号相关，需要使用CUT_ready控制->1可以切断反压信号，两个周期传递一次数据；
  + 大于1：fifo，CUT_READY无实际意义；
  + 在蜂鸟中，DP只有1或者2，也就是说要么是控制ready信号，反压；要么是一个深度为2的fifo；


### 3. buf

 #### (1). sirv_gnrl_pipe_stage：DP=0，o_dat=i_dat;DP=1

+ 相当于将输入信号打一拍；

### 3. sirv_sram_icb_ctrl：

+ 定义：*The icb_ecc_ctrl module control the ICB access requests to SRAM* ；
  + 内部定义一个bypbuf（含有fifo的bypass buffer），悬空一级流水线，以减少反压ready信号--（通过将输入、输出信号拼接成一个信号传输）；
+ 参数：
  + sram_ctrl_active：高电平sram工作；
  + tcm_cgstop：来自csr mcgstop（0xBFE）控制，蜂鸟自定义，主要用于禁用在debug 中 ITCM中的SRAM门控时钟；

#  一、架构：

+ e203
  + core
  + debug
  + fab
  + general
  + mems
  + perips：存放外设的RTL代码；
  + soc
  + subsys：存放子系统的RTL代码；

<img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230323221458116.png" alt="image-20230323221458116" style="zoom:80%;" />

## 1、整体特性：

1. 2级流水线处理器核；RV32IEMAC；
2. 机器模式；
   1. CLINT：计时器中断、软件中断；
   2. PLIC：外部中断， Platform Level Interrupt Controller；用于多个外部中断源的优先级仲裁和派发；
      1. 是一个存储器地址映射（Memory Address Mapped）的模块，挂载在处理器核为其实现的专用总线接口上；
   3. 地址非对齐（Address Misalign）：与Rocket Core 采用软件支持，AGU 通过对生成 出的访存地址进行判断，如果其地址非对齐，则产生异常标志；
   4. 自定义CSR：mcounterstop<img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230316102636811.png" alt="image-20230316102636811" style="zoom:50%;" />
3. SoC总线：ICB-Internal Chip Bus，内核+Soc总线；-----（信号有点怪啊，他这里ready代表相对应接收到数据）
   1. 特点：AXI
      1. 简单，仅有两个独立通道-读写共用**地址通道**，公用结果**返回通道**；
      2. 地址、数据分离；
      3. 地址区间寻址，支持任意的主从数目；
      4. 支持地址非对齐的数据访问，字节掩码（Write Mask）控制写操作；
      5. 支持多个***滞外交易***（Multiple Outstanding Transaction）
   2. 特点：AHB
      1. 每个读/写都会在**地址通道**上产生地址；
      2. 不支持乱序返回、乱序完成，返回通道数据<u>顺序返回结果</u>；
   3. 协议信号：<img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230313164338135.png" alt="image-20230313164338135" style="zoom:50%;" />
   4. 时序：见文档；
4. SOC框图：
   1. <img src="https://doc.nucleisys.com/hbirdv2/_images/overview_fig1.jpg" alt="overview_fig1" style="zoom:80%;" />
   2. <img src="https://doc.nucleisys.com/hbirdv2/_images/core_fig1.jpg" alt="core_fig1" style="zoom: 50%;" />
   3. <img src="https://doc.nucleisys.com/hbirdv2/_images/core_fig2.jpg" alt="core_fig2" style="zoom: 50%;" />

## IFU：<img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230322214319073.png" alt="image-20230322214319073" style="zoom:67%;" />

1. 分支预测：静态，向后跳转为真；

+ e203_exu_oitf：Outstanding Instructions Track FIFO
  + 功能：检测出与长指令的RAW和WAW相关性；
  + fifo，深度为2表项，存储已派遣且尚未写回的长指令信息；
  + 流水线的派遣（Dispatch ）点，每次派遣一个长指令，则会在 OITF 中分配一个表项（Entry），在这个表项中会存储该长指令的<u>源操作数寄存器索引</u>和<u>结果寄存器索引</u>；
+ bpu：静态，向后跳转，向前不跳；
  + 跳转：默认JAL/JALR跳转，b*** 只有立即数最高位为1（负数，向后跳转）
  + JALR特殊处理：见文档
    + X0：；
    + X1：；
    + 其他：；

#### IFU取指过程：

1. 将预测地址低16位写入 ifuitcm 中取指，将会在下个时钟上升沿得到 64 bits数据；
   1. 这里如果是32位指令，addr需要四字节掩码对齐；如果压缩指令，就会直接取最低16位，其余部分存入缓存中；
   2. 其中内部含有一个缓存Buffer，参考蜂鸟7.3.5访问ITCM和BIU；
2. 疑问：
   1. 若将AXI以外设接入，取指都是经过ITCM，但ITCM大小有限，遇到ITCM之外的指令呢？
      1. 那么取指是不经过ITCM接口，而是用过ifu2biu接口，访问总线呢？还是让ITCM访问总线呢？
   2. ITCM中保存指令是通过上电Flash冲刷保存数据，但其中保存数据以是固定的。

##### ift2icb;

1. ifu2biu_icb_cmd_valid：
   1. ifu_icb_cmd_valid：；
   2. ifu_icb_cmd2biu：*当有ITCM时，0x8000处地址都在ITCM寻指，其余地址触发ICB总线*


## EXU：

<img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230322215720738.png" alt="image-20230322215720738" style="zoom:67%;" />



### OITF：

+ Outstanding Instructions Track FIFO，深度为2表项的FIFO；
+ <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230323085121077.png" alt="image-20230323085121077" style="zoom:67%;" />
+ 

## WB：

+ <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230323092541903.png" alt="image-20230323092541903" style="zoom:67%;" />
  + 只要前序指令没发生“分支预测错误”、“中断”、“异常”就成功交付；
+ <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230323095746563.png" alt="image-20230323095746563" style="zoom:67%;" />

### MEM：

+ AGU：Address Generation Unit
  + Load、store、“A“扩展指令的地址生成，以及”A“扩展指令的微操作拆分和执行；
  + 整个存储器访问指令执行的一个小环节！！！！---- 总线用得到
  + 含**有ICB接口**
+ LSU：Load Store Unit ---参考11.4.3 P191
  + ICB总线 ：输入AGU、EAI；输出：BIU、DTCM、ITCM；
  + 学习知识点：ICB汇合、ICB分发--第12章
  + <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230315161701123.png" alt="image-20230315161701123" style="zoom:50%;" />
+ ITCM：<img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230313204101368.png" alt="image-20230313204101368" style="zoom:50%;" />
  + 若将AXI4以外设接入ICB模块，其中在蜂鸟取指处理中只有0x8000_xxxx是映射itcm，其余都是映射到BIU。其中在tb文件中是将测试文件中的[0: 0x0001_0000]保存在ITCM中。
    + 遇到ITCM映射之外的指令-----从外部存储器中读取，IFU通过BIU使用系统存储接口访问外部的存储器。比如系统上电后的引导程序可能从外部Flash中读取）
    + ITCM就是映射一部分内存，所以当Store存储地址恰好在ITCM区间就会触发LSU；
  + sram接口信号：ds、sd低电平，ls为cpu发出信号，目前还不知道功能（cpu->ITF-- ICB Interface from Ifetch应该为clk_ctrl）；
  + ICB总线接口：
    + 一组输入：数据宽度32位，LSU访问，用于上电存储数据；
    + 两组输入：数据宽度 64 位的 IFU 专用ICB 接口，数据宽度 32 位的外部直接访问（外部接口，便于其他外设访问）；
    + 三组总线汇总为一组ICB总线，优先级：LSU > 外部接口> IFU；
  + 64位单口SRAM，可配置大小（LSU、ITCM位宽位32位，需要数据转换）；
  + 模块原理：
    + 先LSU、ITCM外设 数据位宽通过实例化 **sirv_gnrl_icb_n2W** 扩展到64位（ext2itcm -> ext）；
    + 然后将二者将其控制信号拼接为<u>位宽*2</u>的信号（{ext，lsu} ->arbt_bus），通过实例化 **sirv_gnrl_icb_arbt** 仲裁（主要是仲裁LSU与ext优先级，arbt_bus -> arbt）；
    + 然后将仲裁arbt信号与ifu选择通过优先级（IF > LSU > 外设）控制，生成icb接口信号；
    + 通过实例化 **<u>sirv_sram_icb_ctrl</u>** 模块将icb接口信号转换为sram接口信号以及cmd、rsp反馈信号；
      + 内部实例化 sirv_gnrl_bypbuf 模块，将cmd 输入信号缓存一周期，防止ready反压；
      + 实例化 sirv_1cyc_sram_ctral 模块，将缓存icb总线信号处理生成相对应sram信号以及反馈信号；
  + <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230315162243291.png" alt="image-20230315162243291" style="zoom: 80%;" />
+ DTCM：
  + <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230315163413170.png" alt="image-20230315163413170" style="zoom:50%;" />
  + 32位单口SRAM；
  + 两组ICB输入总线，LSU、外部直接访问接口，同理汇总为一条总线，LSU>外部接口；
+ "A"扩展指令处理：在多线程情形下访问存储器的原子（Atomic）操作或者同步操作
  + Load-Reserved和Store-Conditonal：LSU设置互斥检测器（EXclusive Monitor）；
  + AMO（Atomic Memory Operation）指令；
+ Fence指令：
  + RISC-V架构采用松散存储器模型，松散存储器模型对于访问不同地址的存储器读写指令的执行顺序不作要求，除非使用明确的存储器屏障指令（Fence、Fence.I：用于强行界定存储器访问的顺序）；
    + 在程序中，如果添加了 Fence 指令，则 Fence 指令能够保证“在 Fence 之前所有指令造成的访存结果”必须比“在 Fence 之后所有指令造成的访存结果”先被观测到。
    + 在程序中，如果添加了 Fence .I 令，则“在 Fence.I 之后所有指令的取指令操作” 定能够观测到“在 Fence.I 之前所有指令造成的访存结果”；

  + 处理：蜂鸟——fence当成 fence iorw，iorw指令实现；在流水线派遣点，必须等待所有已经滞外的指令执行完毕；

## ICB：



+ <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230315185005739.png" alt="image-20230315185005739" style="zoom:50%;" />
  + fifo：支持滞外交易，主要用于仲裁输出反馈信号；
  + <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230323220820513.png" alt="image-20230323220820513" style="zoom:80%;" />
  + <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230323220828745.png" alt="image-20230323220828745" style="zoom:80%;" />


### ICB2AXI:

+ 注意：ICB不支持brust



## EAI：16章

+ <img src="C:\Users\ZPN\AppData\Roaming\Typora\typora-user-images\image-20230316084653070.png" alt="image-20230316084653070" style="zoom:67%;" />
+ **滞外指令**：Custom指令从被发送至协处理器到协处理器反馈并退役之间的时间；（不超过4条）
+ 读写存储器优先级：协处理器>主处理器指令


